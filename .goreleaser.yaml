# Make sure to check the documentation at https://goreleaser.com
# yaml-language-server: $schema=https://goreleaser.com/static/schema.json
# vim: set ts=2 sw=2 tw=0 fo=cnqoj

# This is a goreleaser file to build the linux binary.
# It was initially generated by goreleaser init
# You can build locally (even non-linux) by running:
# goreleaser build  --snapshot --single-target
before:
  hooks:
    - pwd
      #    - go mod tidy
      #    - go mod tidy -e

env:
  # define env vars so we can refer to them in {{ index .Env ... }} below
  # For the names of the cross compilers in the goreleaser-cross image, see
  # https://github.com/goreleaser/goreleaser-cross/tree/v1.20.4#supported-toolchainsplatforms
  - CC_darwin_amd64=o64-clang
  - CCX_darwin_amd64=o64-clang++
  - CC_darwin_arm64=oa64-clang
  - CCX_darwin_arm64=oa64-clang++
  - CC_linux_amd64=x86_64-linux-gnu-gcc
  - CCX_linux_amd64=x86_64-linux-gnu-g++
  - CC_linux_arm64=aarch64-linux-gnu-gcc
  - CCX_linux_arm64=aarch64-linux-gnu-g++

builds:
  - binary: splitsh-lite
    goos:
      - darwin
    goarch:
      - arm64
    # -tags=static: use staticically linked git2go
    # https://github.com/libgit2/git2go/tree/v34.0.0#main-branch-or-vendored-static-linking
    # to debug, add -v, -x
    flags: [-tags=static, -trimpath, -v, -x ]
    hooks:
      pre:
        # Fix for exec: "pkg-config": executable file not found in $PATH
        # Since goreleaser-cross docker image does not contain pkg-config,
        # we install a fake pkg-config and then add the CGO_CFLAGS and CGO_LDFLAGS manually below
        - bash -c "echo '#!/bin/bash' > /usr/local/bin/pkg-config && chmod +x /usr/local/bin/pkg-config"
        - make --debug libgit2
    ldflags:
      # By default, goreleaser adds -s -w to remove the symbols and debugging information
      # https://github.com/goreleaser/goreleaser/blob/v1.9.2/www/docs/customization/build.md#builds
      # but jobsworth is only 13MB so that is negligible for us so we take out those flags
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}
      - -X main.builtBy=goreleaser
    env:
      - CGO_ENABLED=1
      # Based on documentation example using templates on environment variables:
      # https://goreleaser.com/customization/builds/#complex-template-environment-variables
      - 'CC={{ index .Env (print "CC_" .Os "_" .Arch) }}'
      - 'CCX={{ index .Env (print "CCX_" .Os "_" .Arch) }}'
      # this is used by Makefile so it is relative to jobsworth
      - 'LIBGIT2_STATIC_BUILD_DIR=git2go/static-build-{{ .Os }}-{{ .Arch }}'
      # Fix for exec: "pkg-config": executable file not found in $PATH
      # Since goreleaser-cross docker image does not contain pkg-config,
      # we install a fake pkg-config above and define CGO_CFLAGS and CGO_LDFLAGS
      # to replicate the pkg-config call:
      # https://github.com/libgit2/git2go/blob/v34.0.0/Build_bundled_static.go#L9
      - CGO_CFLAGS_DISALLOW=pkg-config.*
      - 'CGO_CFLAGS=-I{{ .Env.PWD }}/git2go/static-build-{{ .Os }}-{{ .Arch }}/install/include'
      - 'CGO_LDFLAGS=-L{{ .Env.PWD }}/git2go/static-build-{{ .Os }}-{{ .Arch }}/install/lib -lgit2'

archives:
  - format: tar.gz
    # this name template makes the OS and Arch compatible with the results of `uname`.
    name_template: >-
      {{ .ProjectName }}_
      {{- title .Os }}_
      {{- if eq .Arch "amd64" }}x86_64
      {{- else if eq .Arch "386" }}i386
      {{- else }}{{ .Arch }}{{ end }}
      {{- if .Arm }}v{{ .Arm }}{{ end }}
    # use zip for windows archives
    format_overrides:
      - goos: windows
        format: zip


changelog:
  skip: true



#    env:
#      - CGO_ENABLED=0
#      - PATH="/usr/local/opt/libgit2@1.5/bin:$PATH"
#      - LDFLAGS="-L/usr/local/opt/libgit2@1.5/lib"
#      - CPPFLAGS="-I/usr/local/opt/libgit2@1.5/include"
#      - PKG_CONFIG_PATH="/usr/local/opt/libgit2@1.5/lib/pkgconfig"
